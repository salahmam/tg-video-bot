import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import yt_dlp

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„ÙˆØ¬
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† Render Environment
BOT_TOKEN = os.getenv("BOT_TOKEN")

# Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù„ÙŠ Ù„Ø§Ø²Ù… ÙŠÙ†Ø¶Ù… Ù„Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
REQUIRED_CHANNELS = ["@https://t.me/supreme_choice", "@https://t.me/supreme_choice"]


# âœ… Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
async def check_subscription(update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
    user_id = update.effective_user.id
    for channel in REQUIRED_CHANNELS:
        try:
            member = await context.bot.get_chat_member(channel, user_id)
            if member.status not in ["member", "administrator", "creator"]:
                return False
        except Exception as e:
            logger.warning(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† {channel}: {e}")
            return False
    return True


# âœ… Ø£Ù…Ø± /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [[InlineKeyboardButton("ğŸ“¢ Ø§Ø´ØªØ±Ùƒ Ø¨Ø§Ù„Ù‚Ù†Ø§Ø© 1", url="https://t.me/supreme_choice")],
                [InlineKeyboardButton("ğŸ“¢ Ø§Ø´ØªØ±Ùƒ Ø¨Ø§Ù„Ù‚Ù†Ø§Ø© 2", url="https://t.me/supreme_choice")]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„ØªØ­Ù…ÙŠÙ„.\n\n"
        "ğŸ“Œ ÙŠØ¬Ø¨ Ø£Ù† ØªØ´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª:",
        reply_markup=reply_markup
    )


# âœ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
async def download_video(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await check_subscription(update, context):
        await update.message.reply_text("âš ï¸ ÙŠØ¬Ø¨ Ø£Ù† ØªØ´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„.")
        return

    url = update.message.text
    await update.message.reply_text("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...")

    try:
        ydl_opts = {
            "format": "mp4",
            "outtmpl": "%(title)s.%(ext)s"
        }

        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(url, download=True)
            file_name = ydl.prepare_filename(info)

        await update.message.reply_video(video=open(file_name, "rb"))
        os.remove(file_name)

    except Exception as e:
        logger.error(e)
        await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·.")


# âœ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
def main():
    app = Application.builder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, download_video))

    app.run_polling()


if __name__ == "__main__":
    main()
